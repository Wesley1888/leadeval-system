# 数据库更新指南

## 概述

本指南将帮助您安全地更新中煤平朔集团有限公司中层管理人员考核系统的数据库结构，以符合新的考核办法要求。

## 更新前准备

### 1. 备份现有数据

在执行任何数据库更改之前，请务必备份现有数据：

```bash
# 备份整个数据库
mysqldump -u root -p lead_eval > backup_$(date +%Y%m%d_%H%M%S).sql

# 或者备份特定表
mysqldump -u root -p lead_eval person code score admin > tables_backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 检查当前数据库状态

```sql
-- 查看当前表结构
SHOW TABLES;

-- 查看各表的记录数
SELECT 'person' as table_name, COUNT(*) as count FROM person
UNION ALL
SELECT 'code' as table_name, COUNT(*) as count FROM code
UNION ALL
SELECT 'score' as table_name, COUNT(*) as count FROM score
UNION ALL
SELECT 'admin' as table_name, COUNT(*) as count FROM admin;
```

## 执行更新

### 方法一：使用更新脚本（推荐）

1. **下载更新脚本**
   - 使用 `docs/数据库更新脚本.sql` 文件

2. **执行更新**
   ```bash
   mysql -u root -p lead_eval < docs/数据库更新脚本.sql
   ```

3. **验证更新结果**
   ```sql
   -- 检查新表是否创建成功
   SHOW TABLES;
   
   -- 检查数据迁移是否成功
   SELECT COUNT(*) as persons_count FROM persons;
   SELECT COUNT(*) as codes_count FROM evaluation_codes;
   SELECT COUNT(*) as scores_count FROM scores;
   ```

### 方法二：手动执行（分步骤）

如果您希望分步骤执行，可以按照以下顺序：

#### 步骤1：创建新表
```sql
-- 创建部门表
CREATE TABLE IF NOT EXISTS `departments` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT '部门名称',
  `code` VARCHAR(50) NULL COMMENT '部门编码',
  `parent_id` INT(11) NULL COMMENT '上级部门ID',
  `level` INT(11) NOT NULL DEFAULT 1 COMMENT '部门层级',
  `type` VARCHAR(50) NOT NULL COMMENT '部门类型',
  `status` TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态（1:启用 0:禁用）',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_parent_id` (`parent_id`),
  INDEX `idx_type` (`type`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';
```

#### 步骤2：插入初始数据
```sql
-- 插入部门数据
INSERT INTO `departments` (`name`, `code`, `type`, `level`) VALUES
('中煤平朔集团有限公司', 'PS001', '职能管理部门', 1),
('人力资源部', 'PS002', '职能管理部门', 2),
('党委组织部', 'PS003', '职能管理部门', 2),
('财务部', 'PS004', '职能管理部门', 2),
('生产部', 'PS005', '职能管理部门', 2),
('安全部', 'PS006', '职能管理部门', 2);

-- 插入考核指标数据
INSERT INTO `evaluation_indicators` (`name`, `category`, `weight`, `description`, `sort_order`) VALUES
('政治素质', '政治素质', 20.00, '贯彻执行集团公司的有关方针、政策，能同公司党政保持一致；有坚定的理想信念和搞好国有企业的信心与决心；顾全大局，贯彻落实公司有关决议和会议精神；团结协作、维护班子整体形象', 1),
('工作业绩', '工作业绩', 30.00, '树立科学的发展观和正确的业绩观；按照月度、年度任务目标，科学谋划本单位（部门）或分管的安全、生产、经营等各项管理工作，提高工作效率；围绕本单位的指标任务和分管业务，进行任务分解、落实和完成情况', 2),
('领导能力', '领导能力', 20.00, '制定和执行战略决策的能力、开拓创新能力、经营管理能力、市场应变能力、风险防范能力、驾驭复杂局面能力', 3),
('勤勉尽责', '勤勉尽责', 20.00, '有强烈的事业心和责任感；勤奋敬业、求真务实；不畏困难、扎实工作；深入基层、讲求实效', 4),
('廉洁自律', '廉洁自律', 10.00, '落实党风廉政建设责任制，规范经营、清正廉洁；生活作风俭朴、工作作风正派；坚持有关重大事项报告制度；遵守集团公司经营工作"十条禁令"规定及平朔公司有关要求', 5);
```

#### 步骤3：迁移现有数据
```sql
-- 迁移人员数据
INSERT INTO `persons` (`name`, `department_id`, `current_position`, `status`)
SELECT name, department_id, '待更新', 1 FROM `persons_old`;

-- 迁移考核码数据
INSERT INTO `evaluation_codes` (`code`, `department_id`, `evaluator_type`, `weight`, `status`)
SELECT id, department_id, 
  CASE 
    WHEN role LIKE '%总经理%' THEN '公司班子成员'
    WHEN role LIKE '%党委书记%' THEN '公司班子成员'
    WHEN role LIKE '%正科%' THEN '中层管理人员'
    ELSE '基层管理人员'
  END,
  CASE 
    WHEN role LIKE '%总经理%' THEN 20.00
    WHEN role LIKE '%党委书记%' THEN 20.00
    WHEN role LIKE '%正科%' THEN 25.00
    ELSE 25.00
  END,
  CASE WHEN used = 1 THEN 2 ELSE 1 END
FROM `evaluation_codes_old`;
```

## 更新后验证

### 1. 检查表结构
```sql
-- 查看所有表
SHOW TABLES;

-- 检查新表结构
DESCRIBE departments;
DESCRIBE persons;
DESCRIBE evaluation_codes;
DESCRIBE evaluation_tasks;
DESCRIBE evaluation_indicators;
DESCRIBE scores;
DESCRIBE admins;
DESCRIBE system_logs;
```

### 2. 检查数据完整性
```sql
-- 检查各表记录数
SELECT 'departments' as table_name, COUNT(*) as count FROM departments
UNION ALL
SELECT 'persons' as table_name, COUNT(*) as count FROM persons
UNION ALL
SELECT 'evaluation_codes' as table_name, COUNT(*) as count FROM evaluation_codes
UNION ALL
SELECT 'evaluation_tasks' as table_name, COUNT(*) as count FROM evaluation_tasks
UNION ALL
SELECT 'evaluation_indicators' as table_name, COUNT(*) as count FROM evaluation_indicators
UNION ALL
SELECT 'scores' as table_name, COUNT(*) as count FROM scores
UNION ALL
SELECT 'admins' as table_name, COUNT(*) as count FROM admins;
```

### 3. 测试基本功能
```sql
-- 测试查询功能
SELECT p.name, d.name as department, p.current_position
FROM persons p
JOIN departments d ON p.department_id = d.id
LIMIT 10;

-- 测试考核码查询
SELECT code, evaluator_type, weight, status
FROM evaluation_codes
LIMIT 10;
```

## 回滚方案

如果更新过程中出现问题，可以使用以下方法回滚：

### 1. 恢复备份
```bash
# 恢复整个数据库
mysql -u root -p lead_eval < backup_20241201_143000.sql

# 或者恢复特定表
mysql -u root -p lead_eval < tables_backup_20241201_143000.sql
```

### 2. 删除新表并恢复旧表
```sql
-- 删除新创建的表
DROP TABLE IF EXISTS departments;
DROP TABLE IF EXISTS persons;
DROP TABLE IF EXISTS evaluation_codes;
DROP TABLE IF EXISTS evaluation_tasks;
DROP TABLE IF EXISTS evaluation_indicators;
DROP TABLE IF EXISTS scores;
DROP TABLE IF EXISTS admins;
DROP TABLE IF EXISTS system_logs;

-- 恢复旧表名
RENAME TABLE persons_old TO person;
RENAME TABLE evaluation_codes_old TO code;
RENAME TABLE scores_old TO score;
RENAME TABLE admins_old TO admin;
```

## 注意事项

1. **备份重要**：在执行任何数据库更改之前，请务必备份数据
2. **测试环境**：建议先在测试环境中执行更新脚本
3. **停机时间**：更新过程可能需要几分钟，建议在系统使用较少的时间进行
4. **权限检查**：确保数据库用户有足够的权限执行DDL操作
5. **外键约束**：新表结构包含外键约束，确保数据完整性
6. **重复键问题**：如果遇到重复键错误，请运行 `fix-database.bat` 修复脚本

## 常见问题解决

### 1. 重复键错误 (1062 - Duplicate entry)

如果遇到类似 `1062 - Duplicate entry 'admin' for key 'admins.uk_username'` 的错误：

**解决方案：**
```bash
# 运行修复脚本
fix-database.bat
```

**手动修复：**
```sql
-- 清理重复的管理员账号
DELETE a1 FROM admins a1
INNER JOIN admins a2 
WHERE a1.id > a2.id AND a1.username = a2.username;

-- 确保只有一个admin账号
DELETE FROM admins WHERE username = 'admin' AND id != (
  SELECT min_id FROM (
    SELECT MIN(id) as min_id FROM admins WHERE username = 'admin'
  ) as temp
);
```

### 2. 外键约束错误

如果遇到外键约束错误，请检查：
- 确保引用的表存在
- 确保引用的数据存在
- 检查数据类型是否匹配

### 3. 权限不足错误

确保数据库用户有足够权限：
```sql
-- 授予必要权限
GRANT ALL PRIVILEGES ON lead_eval.* TO 'your_user'@'localhost';
FLUSH PRIVILEGES;
```

## 更新完成后的操作

1. **更新应用程序**：确保前端和后端代码与新的数据库结构兼容
2. **测试功能**：全面测试系统的各项功能
3. **清理旧表**：确认新系统正常运行后，可以删除旧表
4. **更新文档**：更新相关的技术文档和用户手册

## 联系支持

如果在更新过程中遇到问题，请：

1. 保存错误日志
2. 记录执行的具体步骤
3. 联系技术支持团队

---

**重要提醒**：数据库更新是不可逆操作，请务必在更新前做好完整备份！ 