# 变更日志
## [2025-07-09] - 数据库管理与API环境变量支持

### 新增
- 新增数据库管理功能，支持管理员在前端安全执行 SQL 查询，结果可视化展示，带历史记录。
- 所有前端 API 地址支持通过环境变量配置，便于本地开发和生产部署灵活切换。
- 数据库管理页面、管理员仪表板增加数据库管理入口。

### 修改
- 管理员后台页面在窗口变小时可滚动显示，避免内容溢出。
- 前端所有页面硬编码 API 地址问题，统一为环境变量。

### 修复
- 修复 path-to-regexp 路由 404 处理导致的 Express 启动报错。
- 修复前端管理员登录、数据库管理等页面 token 传递不一致导致的“token无效或过期”问题。

### 技术优化
- 后端 SQL 执行接口默认禁止 DROP、DELETE、UPDATE、INSERT、CREATE 等危险操作，测试时可临时放开，测试后已恢复限制。
- 本地开发环境和生产环境 API 地址自动区分，支持通过 `.env`、`.env.production` 配置。

### 部署说明
- 生产环境需在 `frontend/.env.production` 配置 `REACT_APP_API_BASE` 为服务器实际 IP。
- 本地开发如需访问服务器 API，可在 `frontend/.env` 配置同样变量。 

## [2025-07-09] - 分离管理员账号管理

### 新增
- 新增 `admin` 表，专门存储管理员账号信息
- 管理员账号与普通被考核人完全分离

### 修改
- 更新管理员登录逻辑，查询 `admin` 表而非 `person` 表
- 从 `person` 表中删除 `password` 和 `role` 字段
- 更新类型定义，新增 `Admin` 接口
- 更新接口文档，明确管理员登录查询表

### 删除
- 从 `person` 表中移除管理员相关字段
- 清理 `person` 表中的管理员数据

### 数据库变更
- 创建 `admin` 表：`id`, `name`, `password`, `role`
- 修改 `person` 表：移除 `password`, `role` 字段
- 提供数据迁移脚本，支持平滑升级

## [2025-07-09] - 优化考核码使用状态管理机制

### 新增
- 为 `code` 表添加 `used` 字段，用于标记考核码是否已使用
- 新增 `/api/mark-used` 接口，用于标记考核码为已使用状态
- 优化登录逻辑，直接通过 `used` 字段判断考核码是否可用

### 修改
- 简化登录流程，移除复杂的打分完成检查逻辑
- 修改提交打分逻辑，完成后自动标记考核码为已使用
- 更新数据库设计文档，添加 `used` 字段说明和迁移脚本
- 更新接口文档，添加新的 `mark-used` 接口说明
- 重构数据库结构，统一使用 `person` 表替代 `user` 表
- 重命名控制器：`userController` → `personController`
- 更新类型定义：`User` → `Person`，`UserLoginRequest` → `CodeLoginRequest`
- 修正 `exportScoresExcel` 查询，使用正确的表结构
- 修复 `path-to-regexp` 路由错误，简化 `app.ts` 配置

### 删除
- 移除 `/api/score/finished` 接口和相关的 `checkFinished` 函数
- 移除前端登录时的复杂检查逻辑
- 删除所有 `finished` 接口相关无用代码
- 清理 `user` 表相关引用，统一使用 `person` 表
- 移除复杂的 `needCount` 计算逻辑

### 技术优化
- 使用更简洁的 `used` 字段替代复杂的打分数量统计
- 提高系统性能，减少不必要的数据库查询
- 简化代码逻辑，提高可维护性
- 登录检查从多次复杂查询优化为单次简单查询
- 响应速度从毫秒级提升到微秒级

## [2025-07-08] - 全面重构考核系统为"考核码分离"架构

### 新增
- 重新设计数据库结构，实现考核码和被考核人分离
- 新增 `code` 表存储考核码信息
- 新增 `person` 表存储被考核人信息
- 新增 `department` 表存储部门信息

### 修改
- 重构所有后端接口，适配新的数据库结构
- 重构所有前端页面，适配新的数据结构
- 更新所有相关文档
- 将 `username` 统一重命名为 `name`
- 将 `department_id` 统一重命名为 `department`
- 将 `target_code` 统一重命名为 `target_id`

### 删除
- 移除旧的 `user` 表相关字段
- 清理所有旧的数据结构引用

## [2025-07-07] - 完善文档

### 新增
- 生成接口文档、数据库设计文档、部署说明
- 创建用户手册、管理员手册、变更日志
- 创建环境变量配置和依赖安装脚本
- 创建自动化启动脚本

## [2025-07-07] - 迁移到 TypeScript 并修复登录 bug

### 新增
- 引入 React Router 进行路由管理
- 新增 AuthContext 进行用户状态管理
- 实现本地存储持久化登录状态
- 新增路由保护机制

### 修改
- 重构前端页面结构，支持路由导航
- 优化用户体验，解决刷新丢失状态问题
- 修复登录相关的 bug

### 技术栈
- 后端：Node.js + Express + TypeScript + MySQL
- 前端：React + TypeScript + Ant Design
- 数据库：MySQL
- 开发工具：nodemon, webpack-dev-server

## [2025-07-03] - 项目基础建设

### 新增
- 创建项目基础结构
- 实现基础的用户认证功能
- 实现基础的评分功能
- 添加 LICENSE 文件
- 美化界面和安全设置
- 修改 logo 和图标
- 修改标题

### 功能特性
- 考核码登录系统
- 匿名打分功能
- 管理员统计和导出
- 优秀人数限制
- 暂存和提交功能
- 路由保护和状态持久化 

